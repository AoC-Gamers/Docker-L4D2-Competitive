# Configuraci√≥n Avanzada

## üìë Tabla de Contenidos

1. [Variables de Entorno Completas](#variables-de-entorno-completas)
2. [Arquitectura de Persistencia y Enlaces Simb√≥licos](#arquitectura-de-persistencia-y-enlaces-simb√≥licos)
3. [Configuraci√≥n de Servidores M√∫ltiples](#configuraci√≥n-de-servidores-m√∫ltiples)
4. [Configuraci√≥n del Workshop](#configuraci√≥n-del-workshop)
5. [Configuraci√≥n de Mapas L4D2Center](#configuraci√≥n-de-mapas-l4d2center)
6. [Configuraci√≥n de Repositorios Git](#configuraci√≥n-de-repositorios-git)
7. [Configuraci√≥n de Red y Puertos](#configuraci√≥n-de-red-y-puertos)
8. [Backup y Restauraci√≥n](#backup-y-restauraci√≥n)
9. [Optimizaci√≥n de Rendimiento](#optimizaci√≥n-de-rendimiento)
10. [Monitoreo y Logs](#monitoreo-y-logs)

---

## Variables de Entorno Completas

### Variables del Contenedor Principal

```bash
# Autenticaci√≥n y Acceso
LGSM_PASSWORD=contrase√±a_segura    # Contrase√±a del usuario linuxgsm
SSH_PORT=2222                      # Puerto SSH personalizado
SSH_KEY=ssh-rsa AAAAB...          # Claves SSH p√∫blicas (separadas por comas)

# Control de Instalaci√≥n
L4D2_NO_INSTALL=false             # Evitar instalaci√≥n autom√°tica del servidor
L4D2_NO_AUTOSTART=false           # Evitar inicio autom√°tico del servidor
L4D2_FRESH_INSTALL=false          # Forzar instalaci√≥n limpia

# Configuraciones de Desarrollo
LGSM_DEV=false                    # Habilitar modo desarrollador
GIT_FORCE_DOWNLOAD=false          # Forzar descarga de repositorios
```

### Variables de LinuxGSM

```bash
# Configuraci√≥n del Repositorio
LGSM_GITHUBUSER=GameServerManagers
LGSM_GITHUBREPO=LinuxGSM
LGSM_GITHUBBRANCH=master

# Directorios del Sistema
LGSM_LOGDIR=/data/log
LGSM_SERVERFILES=/data/serverfiles
LGSM_DATADIR=/data/lgsm
LGSM_CONFIG=/data/lgsm-config
```

## Arquitectura de Persistencia y Enlaces Simb√≥licos

### üîç Separaci√≥n de Directorios: /app vs /data

El proyecto utiliza una arquitectura de **separaci√≥n de responsabilidades** entre directorios:

#### üìÅ Directorio `/app` (No Persistente)
- **Contenido**: Scripts de instalaci√≥n, subscripts, y cach√© de repositorios Git
- **Prop√≥sito**: C√≥digo actualizable con nuevas versiones del contenedor
- **Comportamiento**: Se sobrescribe en cada actualizaci√≥n de imagen
- **Incluye**:
  - `/app/server-scripts/` - Scripts principales
  - `/app/server-scripts/git-gameserver/` - Subscripts de post-procesamiento
  - Cache de repositorios Git clonados

#### üíæ Directorio `/data` (Persistente)
- **Contenido**: Gameserver, configuraciones, logs, y datos de usuario
- **Prop√≥sito**: Informaci√≥n que debe sobrevivir actualizaciones
- **Comportamiento**: Persistente via volumen Docker
- **Incluye**:
  - `/data/serverfiles/` - Archivos del servidor L4D2
  - `/data/lgsm/` - Configuraciones LinuxGSM
  - `/data/log/` - Logs del sistema
  - **Enlaces simb√≥licos** hacia scripts en `/app/`

### ‚öôÔ∏è Configuraci√≥n Obligatoria del Volumen

**En `docker-compose.yml` es OBLIGATORIO:**
```yaml
services:
  comp_l4d2:
    volumes:
      - comp_data:/data  # ‚Üê CR√çTICO: Persistencia de datos
    
volumes:
  comp_data:
    name: comp_data      # ‚Üê OBLIGATORIO: Volumen nombrado
```

**‚ùå Sin este volumen**: 
- Se pierden configuraciones del servidor
- Se pierden mapas y contenido workshop descargado
- Se pierden logs y datos de juego
- Cada reinicio = instalaci√≥n desde cero

### üîó Rol Cr√≠tico de `symlink.sh`

El script `symlink.sh` es **fundamental** para mantener coherencia entre `/app` y `/data`:

#### Proceso de Enlaces Simb√≥licos

```bash
# Enlaces desde /app hacia /data para acceso persistente
/data/menu_gameserver.sh ‚Üí /app/server-scripts/menu_gameserver.sh
/data/lgsm/lgsm/server-scripts/install_gameserver.sh ‚Üí /app/server-scripts/install_gameserver.sh
/data/lgsm/lgsm/server-scripts/workshop_downloader.sh ‚Üí /app/server-scripts/workshop_downloader.sh
# ... todos los scripts de /app/server-scripts/
```

#### Ventajas del Sistema de Enlaces

1. **Acceso Consistente**: Scripts disponibles en `/data` (persistente)
2. **Actualizaciones Autom√°ticas**: Scripts se actualizan con nuevas versiones
3. **Trabajo en `/data`**: Usuarios pueden ejecutar desde directorio persistente
4. **Coherencia**: Modificaciones en `/app` se reflejan autom√°ticamente
5. **Compatibilidad**: LinuxGSM funciona desde `/data` sin problemas

#### Flujo de Actualizaci√≥n

```mermaid
graph TD
    A[üîÑ Actualizaci√≥n Contenedor] --> B[üì¶ Nueva Imagen]
    B --> C[üóÇÔ∏è /app Sobrescrito]
    C --> D[üîó symlink.sh Ejecutado]
    D --> E[üìÅ Enlaces Recreados]
    E --> F[‚úÖ Scripts Actualizados en /data]
    F --> G[üéÆ Gameserver Mantiene Datos]
    
    style C fill:#ff6b6b,stroke:#333,stroke-width:2px
    style F fill:#4ecdc4,stroke:#333,stroke-width:2px
    style G fill:#45b7d1,stroke:#333,stroke-width:2px
```

### üéØ Ejemplo Pr√°ctico de Actualizaci√≥n

**Situaci√≥n**: Se lanza nueva versi√≥n con mejoras en `install_gameserver.sh`

**Sin volumen persistente** ‚ùå:
```bash
docker-compose pull  # Nueva imagen
docker-compose up -d  # ¬°Se pierde TODO!
# Resultado: Reinstalaci√≥n completa desde cero
```

**Con volumen persistente** ‚úÖ:
```bash
docker-compose pull  # Nueva imagen
docker-compose up -d  # Solo se actualiza /app
# Resultado: 
# - Scripts mejorados disponibles autom√°ticamente
# - Gameserver mantiene configuraciones
# - Mapas y workshop preserved
# - Logs hist√≥ricos intactos
```

[üîù Volver arriba](#configuraci√≥n-avanzada)

## Configuraci√≥n de Servidores M√∫ltiples

### Clonaci√≥n de Servidores

El proyecto soporta m√∫ltiples instancias del servidor L4D2:

```bash
# Crear 3 servidores adicionales (total: 4 servidores)
./clone_l4d2server.sh 3

# Configuraci√≥n autom√°tica:
# - l4d2server (servidor principal)
# - l4d2server-2 (clon 1)
# - l4d2server-3 (clon 2) 
# - l4d2server-4 (clon 3)
```

### Configuraci√≥n de Archivos JSON

#### `clone_l4d2server.json`
```json
{
  "amount_clones": 3,
  "server_prefix": "l4d2server",
  "sourcemod_dir_prefix": "sourcemod"
}
```

#### `clone_exclude.json`
Define qu√© archivos copiar vs. enlazar simb√≥licamente:

```json
{
  "configs": ["databases.cfg", "core.cfg"],
  "data": ["system2.cfg"],
  "plugins": ["custom_plugin.smx"]
}
```

### Gesti√≥n de M√∫ltiples Servidores

```bash
# Iniciar servidores del 1 al 3
./menu_gameserver.sh start 1 3

# Detener todos los servidores
./menu_gameserver.sh stop

# Reiniciar servidor espec√≠fico
./menu_gameserver.sh restart 2 2

# Actualizar todos (con parada autom√°tica)
./menu_gameserver.sh update
```

## Configuraci√≥n del Workshop

### Archivo de Configuraci√≥n `.env`

El archivo `.env` en `/data/server-scripts/` cumple una **doble funci√≥n**:

1. **Configuraci√≥n del Workshop Downloader**
2. **Variables para subscripts de instalaci√≥n**

Crear en `/data/server-scripts/.env`:

```bash
# =============================================================================
# CONFIGURACI√ìN DEL WORKSHOP
# =============================================================================
# Art√≠culos individuales del Workshop (IDs separados por comas)
WORKSHOP_ITEMS=123456789,987654321,456789123

# Colecciones del Workshop (IDs separados por comas) 
WORKSHOP_COLLECTIONS=3489804150,2222222222

# Directorio de salida
OUTPUT_DIR=$DIR_LEFT4DEAD2/addons/workshop

# Configuraci√≥n de descarga
BATCH_SIZE=5          # Art√≠culos por lote
BATCH_DELAY=10        # Segundos entre lotes

# =============================================================================
# CONFIGURACI√ìN PARA SUBSCRIPTS DE INSTALACI√ìN
# =============================================================================
# Tokens de autenticaci√≥n para repositorios privados
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STEAM_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Configuraciones espec√≠ficas de modos de juego
COMPETITIVE_MODE=true
TOURNAMENT_MODE=false
CUSTOM_CONFIG_URL=https://github.com/usuario/configuraciones.git

# Variables para plugins espec√≠ficos
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxx/xxx
DATABASE_HOST=localhost
STATS_ENABLED=true
```

**Nota importante**: Los subscripts de post-procesamiento en `git-gameserver/` pueden acceder autom√°ticamente a estas variables ya que `install_gameserver.sh` carga el archivo `.env`.

### Uso del Workshop Downloader

```bash
# Descarga b√°sica
./workshop_downloader.sh

# Con configuraci√≥n personalizada
./workshop_downloader.sh -e mi_config.env -b 10 -d 5

# Con directorio espec√≠fico
./workshop_downloader.sh -o /ruta/personalizada
```

[üîù Volver arriba](#configuraci√≥n-avanzada)

## Configuraci√≥n de Mapas L4D2Center

### Variables de Entorno

```bash
# Forzar descarga de todos los mapas
L4D2_MAPS_FORCE_DOWNLOAD=true

# Descargar solo un mapa espec√≠fico
L4D2_MAP=c1m1_hotel

# Omitir verificaci√≥n MD5 (m√°s r√°pido, menos seguro)
L4D2_MAPS_SKIP_MD5=false
```

### Ejecuci√≥n Manual

```bash
# Descargar/actualizar mapas
./maps_l4d2center.sh

# Solo verificar cambios (sin descargar)
L4D2_MAPS_FORCE_DOWNLOAD=false ./maps_l4d2center.sh
```

## Configuraci√≥n de Repositorios Git

### Archivo `repos.json`

**Configuraci√≥n actual (repositorio real):**
```json
[
  {
    "repo_url": "https://github.com/SirPlease/L4D2-Competitive-Rework.git",
    "folder": "sir",
    "branch": "default"
  }
]
```

**Ejemplos de configuraci√≥n expandida (hipot√©tica):**
```json
[
  {
    "repo_url": "https://github.com/SirPlease/L4D2-Competitive-Rework.git",
    "folder": "sir",
    "branch": "default"
  },
  {
    "repo_url": "https://github.com/usuario/mi-repo.git", 
    "folder": "mi_proyecto",
    "branch": "main"
  },
  {
    "repo_url": "https://${GITHUB_TOKEN}@github.com/private/repo.git",
    "folder": "private_config",
    "branch": "production"
  }
]
```

### Configuraci√≥n Din√°mica de Ramas

El sistema de ramas din√°micas permite modificar autom√°ticamente las ramas de los repositorios seg√∫n las variables de entorno definidas. Esto es especialmente √∫til para diferentes entornos (desarrollo, testing, producci√≥n).

#### üîß Configuraci√≥n desde Docker Compose

**M√©todo 1: Variables en `docker-compose.yml`**
```yaml
services:
  comp_l4d2:
    image: ghcr.io/aoc-gamers/lgsm-l4d2-competitive:latest
    environment:
      - LGSM_PASSWORD=${LGSM_PASSWORD}
      - SSH_PORT=${SSH_PORT}
      - SSH_KEY=${SSH_KEY}
      # Variables de rama din√°micas
      - BRANCH_SIR=development
      # Variables para subscripts (disponibles en install_gameserver.sh)
      - COMPETITIVE_MODE=true
      - DEBUG_ENABLED=false
```

**M√©todo 2: Variables en archivo `.env` principal**
```bash
# Archivo: .env (en la ra√≠z del proyecto)
LGSM_PASSWORD=mi_password_seguro
SSH_PORT=2222
SSH_KEY=ssh-rsa AAAAB...

# Variables BRANCH_* para modificar repos.json din√°micamente
# Solo funciona para folders que existen en repos.json
BRANCH_SIR=development

# Variables adicionales para subscripts de instalaci√≥n
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
COMPETITIVE_MODE=true
TOURNAMENT_MODE=false
```

#### üéØ Sistema de Variables BRANCH_* para repos.json

El script `rep_branch.sh` est√° espec√≠ficamente dise√±ado para **modificar din√°micamente el archivo `repos.json`** usando variables de entorno con el prefijo `BRANCH_*`. 

**Funcionamiento:**
1. **Lee el archivo `repos.json`** actual
2. **Para cada repositorio**, busca una variable `BRANCH_{FOLDER_UPPERCASE}`
3. **Si la variable existe** y no es "default", actualiza el campo `branch`
4. **Guarda el archivo modificado** `repos.json`
5. **`install_gameserver.sh`** usa las nuevas ramas

**Archivo `repos.json` actual:**
```json
[
  {
    "repo_url": "https://github.com/SirPlease/L4D2-Competitive-Rework.git",
    "folder": "sir",
    "branch": "default"
  }
]
```

**Variable para modificar la rama:**
```bash
# Para folder: "sir" ‚Üí Variable: BRANCH_SIR
BRANCH_SIR=development
```

**Resultado despu√©s de `rep_branch.sh`:**
```json
[
  {
    "repo_url": "https://github.com/SirPlease/L4D2-Competitive-Rework.git",
    "folder": "sir",
    "branch": "development"  # ‚Üê Modificado din√°micamente
  }
]
```

**‚ö†Ô∏è Importante**: Las variables `BRANCH_*` solo funcionan si existe un repositorio con el `folder` correspondiente en `repos.json`.

#### üîÑ Casos de Uso por Entorno

**Docker Compose para Desarrollo:**
```yaml
# docker-compose.dev.yml
services:
  comp_l4d2:
    environment:
      # Solo repositorios existentes en repos.json
      - BRANCH_SIR=development
      - DEBUG_MODE=true
      - GIT_FORCE_DOWNLOAD=true
      
      # Ejemplos hipot√©ticos si agregases m√°s repos:
      # - BRANCH_CONFIGS=dev           # Para repo con folder "configs"
      # - BRANCH_PLUGINS=experimental  # Para repo con folder "plugins"
```

**Docker Compose para Testing:**
```yaml
# docker-compose.test.yml
services:
  comp_l4d2:
    environment:
      - BRANCH_SIR=testing
      - L4D2_NO_AUTOSTART=true
      - LOG_LEVEL=debug
```

**Docker Compose para Producci√≥n:**
```yaml
# docker-compose.prod.yml
services:
  comp_l4d2:
    environment:
      # Sin variables BRANCH_* = usa rama "default" de repos.json
      - LGSM_PASSWORD=${LGSM_PASSWORD}
      - SSH_KEY=${SSH_KEY}
      - LOG_LEVEL=warning
```

#### ‚öôÔ∏è Flujo de Modificaci√≥n de repos.json

```mermaid
graph LR
    A[Variables BRANCH_*] --> B[rep_branch.sh]
    B --> C[Lee repos.json]
    C --> D[Modifica campo 'branch']
    D --> E[Guarda repos.json]
    E --> F[install_gameserver.sh]
    F --> G[Clona con nuevas ramas]
```

**Proceso detallado:**
1. **Variables definidas**: Docker Compose o archivo `.env` definen `BRANCH_*`
2. **Lectura**: `rep_branch.sh` lee el archivo `repos.json` actual
3. **Transformaci√≥n**: Convierte `folder` a `BRANCH_{FOLDER_UPPERCASE}`
4. **Modificaci√≥n**: Actualiza solo los repositorios con variables definidas
5. **Persistencia**: Guarda el archivo `repos.json` modificado
6. **Instalaci√≥n**: `install_gameserver.sh` usa las nuevas ramas para clonar
5. **Post-procesamiento**: Ejecuta subscripts: `{folder}.{rama}.sh`

#### üõ†Ô∏è Comandos para Testing

```bash
# Ver variables de rama detectadas
docker-compose exec comp_l4d2 env | grep BRANCH_

# Forzar actualizaci√≥n con nuevas ramas
docker-compose exec comp_l4d2 bash -c "
  cd /app/docker-scripts && ./rep_branch.sh && 
  cd /app/server-scripts && GIT_FORCE_DOWNLOAD=true ./install_gameserver.sh update
"

# Ver repos.json modificado
docker-compose exec comp_l4d2 cat /app/server-scripts/repos.json
```

### Scripts de Post-Procesamiento

Crear scripts personalizados en `git-gameserver/`:

#### `mi_proyecto.main.sh`
```bash
#!/bin/bash
set -euo pipefail

REPO_DIR="$1"
INSTALL_TYPE="${2:-install}"
GIT_DOWNLOAD="${3:-false}"

# Aplicar modificaciones espec√≠ficas al repositorio
if [ "$GIT_DOWNLOAD" = "true" ]; then
    echo "Aplicando configuraciones personalizadas..."
    # Copiar archivos espec√≠ficos
    # Modificar configuraciones
    # etc.
fi
```

## Configuraci√≥n de Red y Puertos

### Docker Compose Personalizado

```yaml
services:
  comp_l4d2:
    image: ghcr.io/aoc-gamers/lgsm-l4d2-competitive:latest
    restart: unless-stopped
    container_name: comp_l4d2
    ports:
      - "27015:27015/udp"  # Servidor L4D2
      - "27020:27020/udp"  # SourceTV
      - "2222:22"          # SSH
    volumes:
      - comp_data:/data
      - ./custom-configs:/data/custom-configs:ro
    environment:
      - LGSM_PASSWORD=${LGSM_PASSWORD}
      - SSH_PORT=22
      - SSH_KEY=${SSH_KEY}
```

## Backup y Restauraci√≥n

### Configuraci√≥n de Backup

```json
{
  "configs": ["databases.cfg", "admins_simple.ini"],
  "data": ["system2.cfg", "basecommands.cfg"],
  "plugins": ["custom_admin.smx"]
}
```

### Scripts de Backup Manual

```bash
# Backup antes de actualizaci√≥n
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz /data/serverfiles/left4dead2/addons/sourcemod/configs

# Restaurar desde backup
tar -xzf backup_20231201_120000.tar.gz -C /
```

## Optimizaci√≥n de Rendimiento

### Configuraci√≥n del Sistema

```bash
# En el host Docker
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 16777216' >> /etc/sysctl.conf
sysctl -p
```

### L√≠mites del Contenedor

```yaml
services:
  comp_l4d2:
    # ... otras configuraciones
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
```

## Monitoreo y Logs

### Configuraci√≥n de Logs

```bash
# Ver logs en tiempo real
tail -f /data/log/l4d2server.log

# Logs del workshop
tail -f /data/server-scripts/workshop_*.log

# Logs de instalaci√≥n
tail -f /data/server-scripts/install_gameserver.log
```

### Healthcheck Personalizado

```bash
# Script personalizado de verificaci√≥n
#!/bin/bash
# Verificar m√∫ltiples servicios
nc -zv localhost 22 && \
nc -zv localhost 27015 && \
pgrep -f "srcds_run" > /dev/null
```
